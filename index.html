<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Sales and Expense Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            color: #2d3748;
        }
        h1, h2 {
            color: #2d3748;
        }
        p, label, span {
            color: #4a5568;
        }
        .container > p {
            color: #6b7280;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-radius: 15px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
            vertical-align: middle;
        }
        th {
            background-color: #edf2f7;
            font-weight: 600;
            color: #2d3748;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .total-row {
            background-color: #e0f2fe;
            font-weight: 700;
            color: #1a202c;
        }
        .rounded-bl { border-bottom-left-radius: 10px; }
        .rounded-br { border-bottom-right-radius: 10px; }

        /* Section styles */
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-yellow-50 { background-color: #fffbeb; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #ecfdf5; }
        .bg-purple-50 { background-color: #f5f3ff; }
        .bg-indigo-50 { background-color: #eef2ff; }


        .p-6 { padding: 24px; }
        .rounded-lg { border-radius: 12px; }
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }

        .form-group label {
            color: #4a5568;
        }
        .form-group input, .form-group select {
            background-color: #ffffff;
            border: 1px solid #cbd5e0;
            color: #2d3748;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background-color: #9ca3af;
        }
        .btn-primary {
            background-color: #4299e1;
            color: white;
            font-size: 1.1em;
        }
        .btn-primary:hover:not(:disabled) { background-color: #3182ce; }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            font-size: 1.1em;
        }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-edit {
            background-color: #f59e0b;
            color: white;
        }
        .btn-edit:hover:not(:disabled) { background-color: #d97706; }
        .btn-delete {
            background-color: #ef4444;
            color: white;
        }
        .btn-delete:hover:not(:disabled) { background-color: #dc2626; }

        .message-box {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-weight: 500;
        }
        .message-box.show { display: block; }
        .message-box.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .message-box.success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .message-box.info { background-color: #cfe2ff; border-color: #b6d4fe; color: #052c65; }

        .settlement-item .amount.positive { color: #10b981; }
        .settlement-item .amount.negative { color: #ef4444; }
        .form-radio { accent-color: #4299e1; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-4">Product Sales and Expense Tracker</h1>
        <p class="text-center mb-6">User ID: <span id="userIdDisplay" class="font-mono text-sm bg-gray-100 px-2 py-1 rounded-md text-gray-800">Loading...</span></p>

        <!-- Quick Calculator -->
        <div class="bg-indigo-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-4">Quick Calculator</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="form-group">
                    <label for="calcQuantity">Quantity</label>
                    <input type="number" id="calcQuantity" placeholder="e.g., 2.5" class="rounded-md" step="any">
                </div>
                <div class="form-group">
                    <label for="calcTotalPrice">Total Price (₹)</label>
                    <input type="number" id="calcTotalPrice" placeholder="e.g., 130" class="rounded-md" step="any">
                </div>
                <div class="form-group">
                    <label for="calcPricePerUnit">Price / Unit (₹)</label>
                    <input type="number" id="calcPricePerUnit" placeholder="e.g., 52.00" class="rounded-md" step="any" readonly>
                </div>
                <div>
                     <button type="button" id="clearCalcBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white w-full">Clear</button>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 id="formTitle" class="text-2xl font-semibold mb-5">Add New Expense</h2>
            <form id="expenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <select id="name" class="rounded-md">
                            <option value="Ram Bachan">Ram Bachan</option>
                            <option value="Bikash">Bikash</option>
                            <option value="Ramesh">Ramesh</option>
                            <option value="Rajkishor">Rajkishor</option>
                            <option value="Raju">Raju</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item">Item:</label>
                        <input type="text" id="item" placeholder="e.g., Apple or Lays" required class="rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantity:</label>
                        <input type="number" id="quantity" min="0" step="0.01" value="1" required class="rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="price">Price per Unit (₹):</label>
                        <input type="number" id="price" min="0.01" step="0.01" required class="rounded-md">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="date">Date:</label>
                        <input type="date" id="date" required class="rounded-md">
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" id="submitBtn" class="btn btn-primary w-full">Add Expense</button>
                    <button type="button" id="cancelEditBtn" class="btn bg-gray-500 text-white w-full hidden">Cancel Edit</button>
                </div>
            </form>
            <div id="messageBox" class="message-box"></div>
        </div>

        <!-- Date Range Filter -->
        <div class="bg-yellow-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-4">Filter Expenses by Date</h2>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center"><input type="radio" name="dateFilter" value="all" checked class="form-radio h-5 w-5" onchange="filterExpenses()"><span class="ml-2">All Time</span></label>
                <label class="inline-flex items-center"><input type="radio" name="dateFilter" value="15" class="form-radio h-5 w-5" onchange="filterExpenses()"><span class="ml-2">Last 15 Days</span></label>
                <label class="inline-flex items-center"><input type="radio" name="dateFilter" value="30" class="form-radio h-5 w-5" onchange="filterExpenses()"><span class="ml-2">Last 30 Days</span></label>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full rounded-lg shadow-md">
                <thead>
                    <tr>
                        <th class="py-3 px-4">#</th>
                        <th class="py-3 px-4">Name</th>
                        <th class="py-3 px-4">Item</th>
                        <th class="py-3 px-4">Qty</th>
                        <th class="py-3 px-4">Price (₹)</th>
                        <th class="py-3 px-4">Date</th>
                        <th class="py-3 px-4">Total (₹)</th>
                        <th class="py-3 px-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <tr><td colspan="8" class="text-center py-4 text-gray-500">Loading expenses...</td></tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="7" class="py-3 px-4 text-right font-bold rounded-bl-lg">Grand Total Expenses:</td>
                        <td id="grandTotal" class="py-3 px-4 font-bold rounded-br-lg">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Expense Summary -->
        <div class="bg-blue-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Expense Summary</h2>
            <p class="text-lg mb-2">Total Expenses: <span id="totalExpensesSummary" class="font-bold text-xl">0.00</span> ₹</p>
            <p class="text-lg">Amount per Person: <span id="amountPerPerson" class="font-bold text-xl">0.00</span> ₹</p>
        </div>

        <!-- Individual Expenses Summary -->
        <div class="bg-green-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Individual Expenses Contributed</h2>
            <ul id="individualExpensesList" class="list-disc list-inside text-lg">
                <!-- Populated by JS -->
            </ul>
        </div>

        <!-- Settlement Section -->
        <div class="bg-purple-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Who Owes Whom?</h2>
            <div id="settlementDetails">
                <p class="text-gray-600">Calculations will appear here.</p>
            </div>
        </div>

        <!-- Clear All Data Button -->
        <div class="mt-6 text-center">
            <button id="clearAllDataBtn" class="btn btn-danger">Clear All Expenses</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, deleteDoc, doc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const ADMIN_PASSWORD = "admin123";

        // --- GLOBAL VARIABLES ---
        let db, auth, userId = null;
        let allSalesData = [];
        const fixedNames = ["Ram Bachan", "Bikash", "Ramesh", "Rajkishor", "Raju"];
        const numberOfPeople = fixedNames.length;

        // --- DOM ELEMENTS ---
        const salesTableBody = document.getElementById('salesTableBody');
        const grandTotalElement = document.getElementById('grandTotal');
        const totalExpensesSummaryElement = document.getElementById('totalExpensesSummary');
        const amountPerPersonElement = document.getElementById('amountPerPerson');
        const expenseForm = document.getElementById('expenseForm');
        const nameInput = document.getElementById('name');
        const itemInput = document.getElementById('item');
        const quantityInput = document.getElementById('quantity');
        const priceInput = document.getElementById('price');
        const dateInput = document.getElementById('date');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageBox = document.getElementById('messageBox');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const settlementDetailsElement = document.getElementById('settlementDetails');
        const individualExpensesList = document.getElementById('individualExpensesList');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editExpenseIdInput = document.getElementById('editExpenseId');
        
        // Quick Calculator Elements
        const calcQuantityInput = document.getElementById('calcQuantity');
        const calcTotalPriceInput = document.getElementById('calcTotalPrice');
        const calcPricePerUnitInput = document.getElementById('calcPricePerUnit');
        const clearCalcBtn = document.getElementById('clearCalcBtn');

        /**
         * Shows a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;
            setTimeout(() => messageBox.classList.remove('show'), 5000);
        }
        
        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        setupRealtimeListener();
                    } else {
                        // Use custom token if available, otherwise sign in anonymously
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Failed to initialize the application. Check console.", 'error');
            }
        }

        /**
         * Sets up a real-time listener for sales data from Firestore.
         */
        function setupRealtimeListener() {
            if (!db || !userId) return;
            const expensesCollectionRef = collection(db, `artifacts/${appId}/public/data/expenses`);
            const q = query(expensesCollectionRef);

            onSnapshot(q, (snapshot) => {
                allSalesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterExpenses();
            }, (error) => {
                console.error("Error fetching real-time data:", error);
                showMessage("Error loading data. Please check Firestore rules and refresh.", 'error');
            });
        }

        /**
         * Filters expenses by date and calls populateTable.
         */
        window.filterExpenses = function() {
            const selectedFilter = document.querySelector('input[name="dateFilter"]:checked').value;
            let filteredData = [...allSalesData];

            if (selectedFilter !== 'all') {
                const days = parseInt(selectedFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                cutoffDate.setHours(0, 0, 0, 0);
                filteredData = filteredData.filter(sale => new Date(sale.date) >= cutoffDate);
            }
            populateTable(filteredData);
        }

        /**
         * Populates the table and summaries with data.
         * @param {Array<Object>} data - The filtered sales data.
         */
        function populateTable(data) {
            salesTableBody.innerHTML = '';
            let totalExpenses = 0;
            let expensesPerPerson = Object.fromEntries(fixedNames.map(name => [name, 0]));

            if (data.length === 0) {
                salesTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">No expenses found.</td></tr>`;
            } else {
                data.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by most recent first
                data.forEach((sale, index) => {
                    const itemTotalPrice = sale.quantity * sale.price;
                    totalExpenses += itemTotalPrice;
                    if (expensesPerPerson.hasOwnProperty(sale.name)) {
                        expensesPerPerson[sale.name] += itemTotalPrice;
                    }
                    
                    const isDisabled = sale.isEdited ? 'disabled' : '';

                    const row = document.createElement('tr');
                    if (sale.isEdited) {
                        row.classList.add('bg-gray-100'); // Style for edited rows
                    }

                    row.innerHTML = `
                        <td class="py-2 px-4">${index + 1}</td>
                        <td class="py-2 px-4">${sale.name}</td>
                        <td class="py-2 px-4">${sale.item}</td>
                        <td class="py-2 px-4">${sale.quantity}</td>
                        <td class="py-2 px-4">${sale.price.toFixed(2)}</td>
                        <td class="py-2 px-4">${sale.date}</td>
                        <td class="py-2 px-4 font-semibold">${itemTotalPrice.toFixed(2)}</td>
                        <td class="py-2 px-4">
                            <div class="flex gap-2">
                                <button class="btn btn-edit text-xs" onclick="startEditExpense('${sale.id}')" ${isDisabled}><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-delete text-xs" onclick="deleteExpense('${sale.id}')" ${isDisabled}><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    `;
                    salesTableBody.appendChild(row);
                });
            }

            // Update summaries
            grandTotalElement.textContent = totalExpenses.toFixed(2);
            totalExpensesSummaryElement.textContent = totalExpenses.toFixed(2);
            const amountPerPerson = totalExpenses > 0 ? totalExpenses / numberOfPeople : 0;
            amountPerPersonElement.textContent = amountPerPerson.toFixed(2);

            // Update individual contributions
            individualExpensesList.innerHTML = '';
            fixedNames.forEach(name => {
                const li = document.createElement('li');
                li.innerHTML = `${name}: <span class="font-bold">${(expensesPerPerson[name] || 0).toFixed(2)}</span> ₹`;
                individualExpensesList.appendChild(li);
            });

            calculateSettlement(expensesPerPerson, amountPerPerson);
        }
        
        /**
         * Calculates and displays who owes whom.
         */
        function calculateSettlement(expensesPerPerson, amountPerPerson) {
            settlementDetailsElement.innerHTML = '';
            if (amountPerPerson === 0) {
                settlementDetailsElement.innerHTML = '<p class="text-gray-600">No expenses to settle.</p>';
                return;
            }

            fixedNames.forEach(name => {
                const balance = (expensesPerPerson[name] || 0) - amountPerPerson;
                const settlementItem = document.createElement('div');
                settlementItem.className = 'settlement-item flex justify-between py-2 border-b border-dashed';
                
                let balanceText = '';
                if (balance < -0.01) { // Use a small tolerance for floating point issues
                    balanceText = `<span class="amount negative">Needs to pay ₹ ${Math.abs(balance).toFixed(2)}</span>`;
                } else if (balance > 0.01) {
                    balanceText = `<span class="amount positive">Is owed ₹ ${balance.toFixed(2)}</span>`;
                } else {
                    balanceText = `<span class="amount">Balanced</span>`;
                }
                settlementItem.innerHTML = `<span>${name}:</span> ${balanceText}`;
                settlementDetailsElement.appendChild(settlementItem);
            });
        }

        /**
         * Handles the form submission for adding or updating an expense.
         */
        async function handleFormSubmit(event) {
            event.preventDefault();
            if (!db || !userId) {
                showMessage("Database not ready. Please wait.", "error");
                return;
            }

            const id = editExpenseIdInput.value;
            const expenseData = {
                name: nameInput.value,
                item: itemInput.value.trim(),
                quantity: parseFloat(quantityInput.value),
                price: parseFloat(priceInput.value),
                date: dateInput.value,
                timestamp: new Date().toISOString()
            };

            if (!expenseData.name || !expenseData.item || isNaN(expenseData.quantity) || expenseData.quantity <= 0 || isNaN(expenseData.price) || expenseData.price <= 0 || !expenseData.date) {
                showMessage("Please fill all fields with valid data.", 'error');
                return;
            }

            try {
                const expensesCollectionRef = collection(db, `artifacts/${appId}/public/data/expenses`);
                if (id) { // Update existing expense
                    expenseData.isEdited = true; // Mark as edited
                    const docRef = doc(expensesCollectionRef, id);
                    await updateDoc(docRef, expenseData);
                    showMessage("Expense updated successfully!", 'success');
                } else { // Add new expense
                    expenseData.isEdited = false; // Initial state
                    await addDoc(expensesCollectionRef, expenseData);
                    showMessage("Expense added successfully!", 'success');
                }
                resetForm();
            } catch (e) {
                console.error("Error saving document: ", e);
                showMessage("Error saving expense. Please try again.", 'error');
            }
        }

        /**
         * Prepares the form for editing an expense.
         * @param {string} id - The Firestore document ID of the expense.
         */
        window.startEditExpense = function(id) {
            const expense = allSalesData.find(s => s.id === id);
            if (!expense || expense.isEdited) return; // Do not allow editing if already edited

            editExpenseIdInput.value = expense.id;
            nameInput.value = expense.name;
            itemInput.value = expense.item;
            quantityInput.value = expense.quantity;
            priceInput.value = expense.price;
            dateInput.value = expense.date;

            formTitle.textContent = "Edit Expense";
            submitBtn.textContent = "Update Expense";
            cancelEditBtn.classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /**
         * Deletes an expense from Firestore after confirmation.
         * @param {string} id - The Firestore document ID of the expense.
         */
        window.deleteExpense = async function(id) {
             const expense = allSalesData.find(s => s.id === id);
             if (expense && expense.isEdited) {
                 showMessage("Cannot delete an expense that has already been edited.", "error");
                 return;
             }
             if (confirm("Are you sure you want to delete this expense? This action cannot be undone.")) {
                 try {
                     const docRef = doc(db, `artifacts/${appId}/public/data/expenses`, id);
                     await deleteDoc(docRef);
                     showMessage("Expense deleted successfully.", 'success');
                 } catch (e) {
                     console.error("Error deleting document: ", e);
                     showMessage("Error deleting expense.", 'error');
                 }
             }
        }

        /**
         * Resets the form to its initial state for adding a new expense.
         */
        function resetForm() {
            expenseForm.reset();
            editExpenseIdInput.value = '';
            formTitle.textContent = "Add New Expense";
            submitBtn.textContent = "Add Expense";
            cancelEditBtn.classList.add('hidden');
            dateInput.value = new Date().toISOString().slice(0, 10);
        }

        /**
         * Clears all data from the 'expenses' collection after password confirmation.
         */
        async function clearAllData() {
            const password = prompt("DANGER: This will delete all data permanently. Enter admin password to proceed:");
            if (password === ADMIN_PASSWORD) {
                if (confirm("FINAL CONFIRMATION: Are you absolutely sure you want to delete all expenses?")) {
                    try {
                        const expensesCollectionRef = collection(db, `artifacts/${appId}/public/data/expenses`);
                        const querySnapshot = await getDocs(query(expensesCollectionRef));
                        const deletePromises = querySnapshot.docs.map(d => deleteDoc(d.ref));
                        await Promise.all(deletePromises);
                        showMessage("All expenses cleared successfully!", 'success');
                    } catch (e) {
                        console.error("Error clearing documents: ", e);
                        showMessage("Error clearing expenses.", 'error');
                    }
                }
            } else if (password !== null) {
                showMessage("Incorrect password. Data not cleared.", 'error');
            }
        }
        
        /**
        * Handles the logic for the quick calculator.
        */
        function handleQuickCalc() {
            const qty = parseFloat(calcQuantityInput.value);
            const total = parseFloat(calcTotalPriceInput.value);

            if (!isNaN(qty) && !isNaN(total)) {
                if (qty !== 0) {
                    calcPricePerUnitInput.value = (total / qty).toFixed(2);
                } else {
                    calcPricePerUnitInput.value = '';
                }
            }
        }

        // --- EVENT LISTENERS ---
        expenseForm.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', resetForm);
        clearAllDataBtn.addEventListener('click', clearAllData);
        
        // Quick Calculator Listeners
        calcQuantityInput.addEventListener('input', handleQuickCalc);
        calcTotalPriceInput.addEventListener('input', handleQuickCalc);
        clearCalcBtn.addEventListener('click', () => {
            calcQuantityInput.value = '';
            calcTotalPriceInput.value = '';
            calcPricePerUnitInput.value = '';
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            initializeFirebase();
            resetForm(); // Set default date on load
        };
    </script>
</body>
</html>
