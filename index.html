<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Sales and Expense Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* Increased max-width for better layout */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            color: #2d3748; /* Default text color for inside containers */
        }
        h1, h2 {
            color: #2d3748; /* Darker headings */
            text-shadow: none; /* Remove text shadow */
        }
        p, label, span {
            color: #4a5568; /* Default text color for labels and paragraphs */
        }
        .container > p { /* Specific styling for the User ID paragraph */
            color: #6b7280; /* Slightly darker gray for user ID */
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px; /* Space between rows */
            background-color: #ffffff; /* Solid white background for table */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            border-radius: 15px;
            overflow: hidden; /* Ensures rounded corners apply to content */
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Light gray border */
            color: #2d3748; /* Darker text for table content */
        }
        th {
            background-color: #edf2f7; /* Lighter blue-gray for header */
            font-weight: 600;
            color: #2d3748;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .total-row {
            background-color: #e0f2fe; /* Light blue for total row */
            font-weight: 700;
            color: #1a202c;
        }
        .rounded-tl { border-top-left-radius: 10px; }
        .rounded-tr { border-top-right-radius: 10px; }
        .rounded-bl { border-bottom-left-radius: 10px; }
        .rounded-br { border-bottom-right-radius: 10px; }
        .rounded-t-lg { border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .rounded-b-lg { border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; }

        /* Original styles for inner sections */
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-yellow-50 { background-color: #fffbeb; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #ecfdf5; }
        .bg-purple-50 { background-color: #f5f3ff; }

        .p-6 { padding: 24px; } /* Consistent padding */
        .rounded-lg { border-radius: 12px; } /* Consistent border-radius */
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); } /* Keep subtle inner shadow */

        .form-group label {
            color: #4a5568; /* Darker text for form labels */
        }
        .form-group input, .form-group select {
            background-color: #ffffff; /* Input background */
            border: 1px solid #cbd5e0;
            color: #2d3748; /* Input text color */
            padding: 10px;
            border-radius: 8px;
        }
        .form-group input::placeholder {
            color: #a0aec0; /* Darker placeholder text */
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .btn-primary {
            background-color: #4299e1;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Lighter button shadow */
        }
        .btn-primary:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .btn-danger { /* New style for danger button */
            background-color: #ef4444; /* Red color */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .message-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-weight: 500;
            backdrop-filter: none; /* Remove backdrop filter */
        }
        .message-box.show {
            display: block;
        }
        /* Restore original message box colors */
        .message-box[style*="background-color: rgb(248, 215, 218)"] { /* error */
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .message-box[style*="background-color: rgb(212, 237, 218)"] { /* success */
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .message-box[style*="background-color: rgb(207, 226, 255)"] { /* info */
            background-color: #cfe2ff;
            border-color: #b6d4fe;
            color: #052c65;
        }

        .settlement-item {
            color: #4a5568; /* Darker text for settlement items */
            border-bottom: 1px dashed #e2e8f0; /* Restore original border */
        }
        .settlement-item .amount.positive {
            color: #10b981; /* Original green */
        }
        .settlement-item .amount.negative {
            color: #ef4444; /* Original red */
        }
        .form-radio {
            accent-color: #4299e1; /* Keep custom color for radio buttons */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-4">Product Sales and Expense Tracker</h1>
        <p class="text-center mb-6">User ID: <span id="userIdDisplay" class="font-mono text-sm bg-gray-100 px-2 py-1 rounded-md text-gray-800">Loading...</span></p>

        <!-- Input Form -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-5">Add New Expense</h2>
            <form id="expenseForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <select id="name" class="rounded-md">
                            <option value="Ram Bachan">Ram Bachan</option>
                            <option value="Bikash">Bikash</option>
                            <option value="Ramesh">Ramesh</option>
                            <option value="Rajkishor">Rajkishor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item">Item:</label>
                        <input type="text" id="item" placeholder="e.g., Apple" required class="rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantity:</label>
                        <input type="number" id="quantity" min="0" step="0.01" value="1" required class="rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="price">Price per Unit (â‚¹):</label>
                        <input type="number" id="price" min="0.01" step="0.01" required class="rounded-md">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="date">Date:</label>
                        <input type="date" id="date" required class="rounded-md">
                    </div>
                </div>
                <button type="submit" class="btn-primary w-full mt-6">Add Expense</button>
            </form>
            <div id="messageBox" class="message-box"></div>
        </div>

        <!-- Date Range Filter -->
        <div class="bg-yellow-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-4">Filter Expenses by Date</h2>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center">
                    <input type="radio" name="dateFilter" value="all" checked class="form-radio h-5 w-5" onchange="filterExpenses()">
                    <span class="ml-2">All Time</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="dateFilter" value="15" class="form-radio h-5 w-5" onchange="filterExpenses()">
                    <span class="ml-2">Last 15 Days</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="dateFilter" value="30" class="form-radio h-5 w-5" onchange="filterExpenses()">
                    <span class="ml-2">Last 30 Days</span>
                </label>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full rounded-lg shadow-md">
                <thead>
                    <tr>
                        <th class="py-3 px-4 rounded-tl-lg">#</th> <!-- New Expense # column -->
                        <th class="py-3 px-4">Name</th>
                        <th class="py-3 px-4">Item</th>
                        <th class="py-3 px-4">Quantity</th>
                        <th class="py-3 px-4">Price per Unit (â‚¹)</th>
                        <th class="py-3 px-4">Date</th>
                        <th class="py-3 px-4 rounded-tr-lg">Total Item Price (â‚¹)</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <!-- Data rows will be inserted here by JavaScript -->
                    <tr><td colspan="7" class="text-center py-4 text-gray-500">Loading expenses...</td></tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="6" class="py-3 px-4 text-right font-bold rounded-bl-lg">Grand Total Expenses:</td>
                        <td id="grandTotal" class="py-3 px-4 font-bold rounded-br-lg">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Expense Summary -->
        <div class="bg-blue-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Expense Summary</h2>
            <p class="text-lg mb-2">Total Expenses: <span id="totalExpensesSummary" class="font-bold text-xl">0.00</span> â‚¹</p>
            <p class="text-lg">Amount per Person (for 4 people): <span id="amountPerPerson" class="font-bold text-xl">0.00</span> â‚¹</p>
        </div>

        <!-- Individual Expenses Summary -->
        <div class="bg-green-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Individual Expenses Contributed</h2>
            <ul class="list-disc list-inside text-lg">
                <li>Ram Bachan: <span id="ramExpenses" class="font-bold">0.00</span> â‚¹</li>
                <li>Bikash: <span id="shyamExpenses" class="font-bold">0.00</span> â‚¹</li>
                <li>Ramesh: <span id="rahulExpenses" class="font-bold">0.00</span> â‚¹</li>
                <li>Rajkishor: <span id="sitaExpenses" class="font-bold">0.00</span> â‚¹</li>
            </ul>
        </div>

        <!-- Settlement Section -->
        <div class="bg-purple-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Who Owes Whom?</h2>
            <div id="settlementDetails">
                <!-- Settlement details will be populated here -->
                <p class="text-gray-600">Calculations will appear here after expenses are added.</p>
            </div>
        </div>

        <!-- Clear All Data Button -->
        <div class="mt-6 text-center">
            <button id="clearAllDataBtn" class="btn-danger">Clear All Expenses</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Import getAnalytics

        // Use the user-provided Firebase configuration directly
        const firebaseConfig = {
            apiKey: "AIzaSyBZcbbPHAJCAQydWR13pNMF1At3md2zjeE",
            authDomain: "expense-ddb7c.firebaseapp.com",
            databaseURL: "https://expense-ddb7c-default-rtdb.firebaseio.com",
            projectId: "expense-ddb7c",
            storageBucket: "expense-ddb7c.firebasestorage.app",
            messagingSenderId: "503722514278",
            appId: "1:503722514278:web:6d44ac24ffe545c97fdaa7",
            measurementId: "G-6GTZWQD65G"
        };
        const appId = firebaseConfig.projectId;

        // Firebase variables
        let app;
        let db;
        let auth;
        let analytics;
        let currentUserId = null;
        let allSalesData = [];

        // DOM Elements
        const salesTableBody = document.getElementById('salesTableBody');
        const grandTotalElement = document.getElementById('grandTotal');
        const totalExpensesSummaryElement = document.getElementById('totalExpensesSummary');
        const amountPerPersonElement = document.getElementById('amountPerPerson');
        const expenseForm = document.getElementById('expenseForm');
        const nameInput = document.getElementById('name');
        const itemInput = document.getElementById('item');
        const quantityInput = document.getElementById('quantity');
        const priceInput = document.getElementById('price');
        const dateInput = document.getElementById('date');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageBox = document.getElementById('messageBox');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn'); // New button element
        const settlementDetailsElement = document.getElementById('settlementDetails');

        // Individual expense display elements
        const ramExpensesElement = document.getElementById('ramExpenses');
        const shyamExpensesElement = document.getElementById('shyamExpenses');
        const rahulExpensesElement = document.getElementById('rahulExpenses');
        const sitaExpensesElement = document.getElementById('sitaExpenses');

        // Fixed names for the dropdown
        const fixedNames = ["Ram Bachan", "Bikash", "Ramesh", "Rajkishor"];
        const numberOfPeople = fixedNames.length;

        // Hardcoded password for clearing data (for demonstration purposes only)
        const ADMIN_PASSWORD = "admin123";

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message (e.g., 'success', 'error', 'warning').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show';
            if (type === 'error') {
                messageBox.style.backgroundColor = '#f8d7da';
                messageBox.style.borderColor = '#f5c6cb';
                messageBox.style.color = '#721c24';
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#d4edda';
                messageBox.style.borderColor = '#c3e6cb';
                messageBox.style.color = '#155724';
            } else {
                messageBox.style.backgroundColor = '#cfe2ff';
                messageBox.style.borderColor = '#b6d4fe';
                messageBox.style.color = '#052c65';
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000);
        }

        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        console.log("User authenticated:", currentUserId);
                        setupRealtimeListener();
                    } else {
                        try {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        } catch (error) {
                            console.error("Error during anonymous sign-in:", error);
                            showMessage("Authentication failed. Please ensure Anonymous Authentication is enabled in your Firebase project.", 'error');
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Failed to initialize the application. Check console for details. Ensure your firebaseConfig is correct.", 'error');
            }
        }

        /**
         * Sets up a real-time listener for sales data from Firestore.
         */
        function setupRealtimeListener() {
            if (!db || !currentUserId) {
                console.warn("Firestore or User ID not ready for listener setup.");
                return;
            }

            const salesCollectionRef = collection(db, `expenses`);
            const q = query(salesCollectionRef);

            onSnapshot(q, (snapshot) => {
                allSalesData = [];
                snapshot.forEach(doc => {
                    allSalesData.push({ id: doc.id, ...doc.data() });
                });
                console.log("Real-time data update (all data):", allSalesData);
                filterExpenses();
            }, (error) => {
                console.error("Error fetching real-time sales data:", error);
                showMessage("Error loading sales data. Please refresh.", 'error');
            });
        }

        /**
         * Filters expenses based on the selected date range and then populates the table.
         */
        window.filterExpenses = function() {
            const selectedFilter = document.querySelector('input[name="dateFilter"]:checked').value;
            let filteredData = [...allSalesData];

            if (selectedFilter !== 'all') {
                const days = parseInt(selectedFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                cutoffDate.setHours(0, 0, 0, 0);

                filteredData = filteredData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= cutoffDate;
                });
            }
            populateTable(filteredData);
        }

        /**
         * Populates the table with sales data and calculates totals.
         * @param {Array<Object>} data - The array of sales data objects (already filtered).
         */
        function populateTable(data) {
            salesTableBody.innerHTML = '';
            let totalExpenses = 0;
            let expensesPerPerson = { "Ram Bachan": 0, "Bikash": 0, "Ramesh": 0, "Rajkishor": 0 };

            if (data.length === 0) {
                salesTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No expenses found for this period.</td></tr>';
            } else {
                data.sort((a, b) => new Date(a.date) - new Date(b.date));

                data.forEach((sale, index) => { // Added index for sequential numbering
                    const row = document.createElement('tr');
                    const itemTotalPrice = sale.quantity * sale.price;
                    totalExpenses += itemTotalPrice;

                    if (expensesPerPerson.hasOwnProperty(sale.name)) {
                        expensesPerPerson[sale.name] += itemTotalPrice;
                    }

                    row.innerHTML = `
                        <td class="py-2 px-4 rounded-md">${index + 1}</td> <!-- Sequential number -->
                        <td class="py-2 px-4 rounded-md">${sale.name}</td>
                        <td class="py-2 px-4 rounded-md">${sale.item}</td>
                        <td class="py-2 px-4 rounded-md">${sale.quantity}</td>
                        <td class="py-2 px-4 rounded-md">${sale.price.toFixed(2)}</td>
                        <td class="py-2 px-4 rounded-md">${sale.date}</td>
                        <td class="py-2 px-4 rounded-md">${itemTotalPrice.toFixed(2)}</td>
                    `;
                    salesTableBody.appendChild(row);
                });
            }

            grandTotalElement.textContent = totalExpenses.toFixed(2);
            totalExpensesSummaryElement.textContent = totalExpenses.toFixed(2);
            const amountPerPerson = totalExpenses / numberOfPeople;
            amountPerPersonElement.textContent = amountPerPerson.toFixed(2);

            ramExpensesElement.textContent = expensesPerPerson["Ram Bachan"].toFixed(2);
            shyamExpensesElement.textContent = expensesPerPerson["Bikash"].toFixed(2);
            rahulExpensesElement.textContent = expensesPerPerson["Ramesh"].toFixed(2);
            sitaExpensesElement.textContent = expensesPerPerson["Rajkishor"].toFixed(2);

            calculateSettlement(expensesPerPerson, amountPerPerson);
        }

        /**
         * Calculates and displays who owes whom.
         * @param {Object} expensesPerPerson - Object with total expenses for each person.
         * @param {number} amountPerPerson - The average amount each person should pay.
         */
        function calculateSettlement(expensesPerPerson, amountPerPerson) {
            settlementDetailsElement.innerHTML = '';

            if (amountPerPerson === 0) {
                settlementDetailsElement.innerHTML = '<p class="text-gray-600">No expenses to settle yet.</p>';
                return;
            }

            fixedNames.forEach(name => {
                const balance = expensesPerPerson[name] - amountPerPerson;
                const settlementItem = document.createElement('div');
                settlementItem.classList.add('settlement-item');

                if (balance < 0) {
                    settlementItem.innerHTML = `
                        <span>${name} needs to pay:</span>
                        <span class="amount negative">â‚¹ ${Math.abs(balance).toFixed(2)}</span>
                    `;
                } else if (balance > 0) {
                    settlementItem.innerHTML = `
                        <span>${name} is owed:</span>
                        <span class="amount positive">â‚¹ ${balance.toFixed(2)}</span>
                    `;
                } else {
                    settlementItem.innerHTML = `
                        <span>${name}:</span>
                        <span class="amount">â‚¹ 0.00 (Balanced)</span>
                    `;
                }
                settlementDetailsElement.appendChild(settlementItem);
            });
        }

        /**
         * Handles the form submission to add a new expense.
         * @param {Event} event - The form submission event.
         */
        async function addExpense(event) {
            event.preventDefault();

            const name = nameInput.value;
            const item = itemInput.value.trim();
            const quantity = parseFloat(quantityInput.value);
            const price = parseFloat(priceInput.value);
            const date = dateInput.value;

            if (!name || !item || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0 || !date) {
                showMessage("Please fill in all fields correctly, ensuring quantity and price are valid numbers greater than zero.", 'error');
                return;
            }

            if (!db) {
                showMessage("Database not initialized. Please wait or refresh.", 'error');
                return;
            }

            const newExpense = {
                name: name,
                item: item,
                quantity: quantity,
                price: price,
                date: date,
                timestamp: new Date().toISOString()
            };

            try {
                const docRef = await addDoc(collection(db, `expenses`), newExpense);
                console.log("Document written with ID: ", docRef.id);
                showMessage("Expense added successfully!", 'success');
                expenseForm.reset();
                dateInput.value = new Date().toISOString().slice(0, 10);
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error adding expense. Please try again. Check your Firestore security rules for write access.", 'error');
            }
        }

        /**
         * Clears all data from the 'expenses' collection in Firestore, with password protection.
         */
        async function clearAllData() {
            if (!db) {
                showMessage("Database not initialized. Please wait or refresh.", 'error');
                return;
            }

            // Custom confirmation message box with password input
            const passwordEntered = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto text-center">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
                        <p class="text-gray-600 mb-4">Enter password to delete ALL expense data:</p>
                        <input type="password" id="adminPasswordInput" class="w-full p-2 border border-gray-300 rounded-md mb-4 text-gray-800" placeholder="Password"/>
                        <p id="passwordError" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p>
                        <div class="flex justify-center space-x-4">
                            <button id="cancelClearBtn" class="px-6 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Cancel</button>
                            <button id="confirmClearBtn" class="px-6 py-2 rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete All</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                const passwordInput = document.getElementById('adminPasswordInput');
                const passwordError = document.getElementById('passwordError');

                document.getElementById('cancelClearBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(null); // Resolve with null if cancelled
                };
                document.getElementById('confirmClearBtn').onclick = () => {
                    if (passwordInput.value === ADMIN_PASSWORD) {
                        document.body.removeChild(modal);
                        resolve(passwordInput.value); // Resolve with the password if correct
                    } else {
                        passwordError.classList.remove('hidden');
                        passwordInput.value = ''; // Clear password input
                    }
                };
                passwordInput.focus(); // Focus on the password input
            });


            if (passwordEntered === ADMIN_PASSWORD) { // Check if the correct password was returned
                try {
                    const q = query(collection(db, `expenses`));
                    const querySnapshot = await getDocs(q);
                    const deletePromises = [];

                    querySnapshot.forEach((docToDelete) => {
                        deletePromises.push(deleteDoc(doc(db, `expenses`, docToDelete.id)));
                    });

                    await Promise.all(deletePromises);
                    showMessage("All expenses cleared successfully!", 'success');
                } catch (e) {
                    console.error("Error clearing documents: ", e);
                    showMessage("Error clearing expenses. Please try again. Check your Firestore security rules for delete access.", 'error');
                }
            } else if (passwordEntered !== null) { // If not null, it means an incorrect password was entered
                showMessage("Incorrect password. Data not cleared.", 'error');
            }
            // If passwordEntered is null, it means the modal was cancelled, no message needed.
        }

        // Set today's date as default for the date input
        dateInput.value = new Date().toISOString().slice(0, 10);

        // Event listeners
        expenseForm.addEventListener('submit', addExpense);
        clearAllDataBtn.addEventListener('click', clearAllData); // Attach event listener to the new button

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
