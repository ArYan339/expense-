<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Sales and Expense Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* Increased max-width for better layout */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            color: #2d3748; /* Default text color for inside containers */
        }
        h1, h2 {
            color: #2d3748; /* Darker headings */
            text-shadow: none; /* Remove text shadow */
        }
        p, label, span {
            color: #4a5568; /* Default text color for labels and paragraphs */
        }
        .container > p { /* Specific styling for the User ID paragraph */
            color: #6b7280; /* Slightly darker gray for user ID */
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px; /* Space between rows */
            background-color: #ffffff; /* Solid white background for table */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            border-radius: 15px;
            overflow: hidden; /* Ensures rounded corners apply to content */
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Light gray border */
            color: #2d3748; /* Darker text for table content */
            vertical-align: middle;
        }
        th {
            background-color: #edf2f7; /* Lighter blue-gray for header */
            font-weight: 600;
            color: #2d3748;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .total-row {
            background-color: #e0f2fe; /* Light blue for total row */
            font-weight: 700;
            color: #1a202c;
        }
        .rounded-tl { border-top-left-radius: 10px; }
        .rounded-tr { border-top-right-radius: 10px; }
        .rounded-bl { border-bottom-left-radius: 10px; }
        .rounded-br { border-bottom-right-radius: 10px; }
        .rounded-t-lg { border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .rounded-b-lg { border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; }

        /* Original styles for inner sections */
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-yellow-50 { background-color: #fffbeb; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-green-50 { background-color: #ecfdf5; }
        .bg-purple-50 { background-color: #f5f3ff; }
        .bg-indigo-50 { background-color: #eef2ff; }


        .p-6 { padding: 24px; } /* Consistent padding */
        .rounded-lg { border-radius: 12px; } /* Consistent border-radius */
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); } /* Keep subtle inner shadow */

        .form-group label {
            color: #4a5568; /* Darker text for form labels */
        }
        .form-group input, .form-group select {
            background-color: #ffffff; /* Input background */
            border: 1px solid #cbd5e0;
            color: #2d3748; /* Input text color */
            padding: 10px;
            border-radius: 8px;
        }
        .form-group input::placeholder {
            color: #a0aec0; /* Darker placeholder text */
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
             transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #4299e1;
            color: white;
            padding: 12px 20px;
            font-size: 1.1em;
        }
        .btn-primary:hover {
            background-color: #3182ce;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .btn-danger { /* New style for danger button */
            background-color: #ef4444; /* Red color */
            color: white;
            padding: 12px 20px;
            font-size: 1.1em;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .message-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-weight: 500;
            backdrop-filter: none; /* Remove backdrop filter */
        }
        .message-box.show {
            display: block;
        }
        /* Restore original message box colors */
        .message-box[style*="background-color: rgb(248, 215, 218)"] { /* error */
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .message-box[style*="background-color: rgb(212, 237, 218)"] { /* success */
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .message-box[style*="background-color: rgb(207, 226, 255)"] { /* info */
            background-color: #cfe2ff;
            border-color: #b6d4fe;
            color: #052c65;
        }

        .settlement-item {
            color: #4a5568; /* Darker text for settlement items */
            border-bottom: 1px dashed #e2e8f0; /* Restore original border */
        }
        .settlement-item .amount.positive {
            color: #10b981; /* Original green */
        }
        .settlement-item .amount.negative {
            color: #ef4444; /* Original red */
        }
        .form-radio {
            accent-color: #4299e1; /* Keep custom color for radio buttons */
        }
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .action-btn:hover {
            transform: translateY(-1px);
        }
        .btn-edit {
            background-color: #3b82f6;
        }
        .btn-edit:hover {
            background-color: #2563eb;
        }
        .btn-delete {
            background-color: #ef4444;
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-4">Product Expense Tracker</h1>
        <p class="text-center mb-6">Your User ID: <span id="userIdDisplay" class="font-mono text-sm bg-gray-100 px-2 py-1 rounded-md text-gray-800">Loading...</span></p>

        <!-- Input Form -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-5">Add New Expense</h2>
            <form id="expenseForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <select id="name" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="Ram Bachan">Ram Bachan</option>
                            <option value="Bikash">Bikash</option>
                            <option value="Ramesh">Ramesh</option>
                            <option value="Rajkishor">Rajkishor</option>
                            <option value="Raju">Raju</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item">Item:</label>
                        <input type="text" id="item" placeholder="e.g., Apple" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantity:</label>
                        <input type="number" id="quantity" min="0" step="0.01" value="1" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="price">Price per Unit (â‚¹):</label>
                        <input type="number" id="price" min="0.01" step="0.01" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="date">Date:</label>
                        <input type="date" id="date" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-full mt-6">Add Expense</button>
            </form>
            <div id="messageBox" class="message-box"></div>
        </div>
        
        <!-- Quick Calculator -->
        <div class="bg-indigo-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-5">Quick Calculator</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="calcQuantity">Quantity:</label>
                    <input type="number" id="calcQuantity" placeholder="e.g., 2.5" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="form-group">
                    <label for="calcTotalPrice">Total Price (â‚¹):</label>
                    <input type="number" id="calcTotalPrice" placeholder="e.g., 130" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="form-group">
                    <label for="calcPricePerUnit">Price / Unit (â‚¹):</label>
                    <input type="number" id="calcPricePerUnit" placeholder="e.g., 52.00" class="w-full p-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-4">
                 <button id="useCalcValuesBtn" class="btn btn-success">Use Values</button>
                 <button id="clearCalcBtn" class="btn btn-secondary">Clear</button>
            </div>
        </div>


        <!-- Date Range Filter -->
        <div class="bg-yellow-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold mb-4">Filter Expenses by Date</h2>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center">
                    <input type="radio" name="dateFilter" value="all" checked class="form-radio h-5 w-5" onchange="filterExpenses()">
                    <span class="ml-2">All Time</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="dateFilter" value="15" class="form-radio h-5 w-5" onchange="filterExpenses()">
                    <span class="ml-2">Last 15 Days</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="dateFilter" value="30" class="form-radio h-5 w-5" onchange="filterExpenses()">
                    <span class="ml-2">Last 30 Days</span>
                </label>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full rounded-lg shadow-md">
                <thead>
                    <tr>
                        <th class="py-3 px-4 rounded-tl-lg">Name</th>
                        <th class="py-3 px-4">Item</th>
                        <th class="py-3 px-4">Quantity</th>
                        <th class="py-3 px-4">Price (â‚¹)</th>
                        <th class="py-3 px-4">Date</th>
                        <th class="py-3 px-4">Total (â‚¹)</th>
                        <th class="py-3 px-4 rounded-tr-lg">Actions</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                    <!-- Data rows will be inserted here by JavaScript -->
                    <tr><td colspan="7" class="text-center py-4 text-gray-500">Loading expenses...</td></tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="6" class="py-3 px-4 text-right font-bold rounded-bl-lg">Grand Total Expenses:</td>
                        <td id="grandTotal" class="py-3 px-4 font-bold rounded-br-lg">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Expense Summary -->
        <div class="bg-blue-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Expense Summary</h2>
            <p class="text-lg mb-2">Total Expenses: <span id="totalExpensesSummary" class="font-bold text-xl">0.00</span> â‚¹</p>
            <p class="text-lg">Amount per Person (for 5 people): <span id="amountPerPerson" class="font-bold text-xl">0.00</span> â‚¹</p>
        </div>

        <!-- Individual Expenses Summary -->
        <div class="bg-green-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Individual Expenses Contributed</h2>
            <ul class="list-disc list-inside text-lg">
                <li>Ram Bachan: <span id="ramExpenses" class="font-bold">0.00</span> â‚¹</li>
                <li>Bikash: <span id="shyamExpenses" class="font-bold">0.00</span> â‚¹</li>
                <li>Ramesh: <span id="rahulExpenses" class="font-bold">0.00</span> â‚¹</li>
                <li>Rajkishor: <span id="sitaExpenses" class="font-bold">0.00</span> â‚¹</li>
                <li>Raju: <span id="rajuExpenses" class="font-bold">0.00</span> â‚¹</li>
            </ul>
        </div>

        <!-- Settlement Section -->
        <div class="bg-purple-50 p-6 rounded-lg shadow-inner mt-6">
            <h2 class="text-2xl font-semibold mb-4">Who Owes Whom?</h2>
            <div id="settlementDetails">
                <!-- Settlement details will be populated here -->
                <p class="text-gray-600">Calculations will appear here after expenses are added.</p>
            </div>
        </div>

        <!-- Clear All Data Button -->
        <div class="mt-6 text-center">
            <button id="clearAllDataBtn" class="btn btn-danger">Clear All Expenses</button>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg mx-auto w-full">
            <h2 class="text-2xl font-semibold mb-5 text-gray-800">Edit Expense</h2>
            <form id="editExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="editName" class="text-gray-600">Name:</label>
                        <select id="editName" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="Ram Bachan">Ram Bachan</option>
                            <option value="Bikash">Bikash</option>
                            <option value="Ramesh">Ramesh</option>
                            <option value="Rajkishor">Rajkishor</option>
                            <option value="Raju">Raju</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editItem" class="text-gray-600">Item:</label>
                        <input type="text" id="editItem" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="editQuantity" class="text-gray-600">Quantity:</label>
                        <input type="number" id="editQuantity" min="0" step="0.01" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="form-group">
                        <label for="editPrice" class="text-gray-600">Price per Unit (â‚¹):</label>
                        <input type="number" id="editPrice" min="0.01" step="0.01" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="editDate" class="text-gray-600">Date:</label>
                        <input type="date" id="editDate" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelEditBtn" class="px-6 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Use the user-provided Firebase configuration directly
        const firebaseConfig = {
            apiKey: "AIzaSyBZcbbPHAJCAQydWR13pNMF1At3md2zjeE",
            authDomain: "expense-ddb7c.firebaseapp.com",
            databaseURL: "https://expense-ddb7c-default-rtdb.firebaseio.com",
            projectId: "expense-ddb7c",
            storageBucket: "expense-ddb7c.firebasestorage.app",
            messagingSenderId: "503722514278",
            appId: "1:503722514278:web:6d44ac24ffe545c97fdaa7",
            measurementId: "G-6GTZWQD65G"
        };
        const appId = firebaseConfig.projectId;

        // Firebase variables
        let app;
        let db;
        let auth;
        let analytics;
        let currentUserId = null;
        let allSalesData = [];

        // DOM Elements
        const salesTableBody = document.getElementById('salesTableBody');
        const grandTotalElement = document.getElementById('grandTotal');
        const totalExpensesSummaryElement = document.getElementById('totalExpensesSummary');
        const amountPerPersonElement = document.getElementById('amountPerPerson');
        const expenseForm = document.getElementById('expenseForm');
        const nameInput = document.getElementById('name');
        const itemInput = document.getElementById('item');
        const quantityInput = document.getElementById('quantity');
        const priceInput = document.getElementById('price');
        const dateInput = document.getElementById('date');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageBox = document.getElementById('messageBox');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const settlementDetailsElement = document.getElementById('settlementDetails');

        // Quick Calculator DOM Elements
        const calcQuantityInput = document.getElementById('calcQuantity');
        const calcTotalPriceInput = document.getElementById('calcTotalPrice');
        const calcPricePerUnitInput = document.getElementById('calcPricePerUnit');
        const useCalcValuesBtn = document.getElementById('useCalcValuesBtn');
        const clearCalcBtn = document.getElementById('clearCalcBtn');


        // Individual expense display elements
        const ramExpensesElement = document.getElementById('ramExpenses');
        const shyamExpensesElement = document.getElementById('shyamExpenses');
        const rahulExpensesElement = document.getElementById('rahulExpenses');
        const sitaExpensesElement = document.getElementById('sitaExpenses');
        const rajuExpensesElement = document.getElementById('rajuExpenses');

        // Fixed names for the dropdown
        const fixedNames = ["Ram Bachan", "Bikash", "Ramesh", "Rajkishor", "Raju"];
        const numberOfPeople = fixedNames.length;

        const ADMIN_PASSWORD = "admin123";

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'message-box show';
            if (type === 'error') {
                messageBox.style.backgroundColor = '#f8d7da';
                messageBox.style.borderColor = '#f5c6cb';
                messageBox.style.color = '#721c24';
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#d4edda';
                messageBox.style.borderColor = '#c3e6cb';
                messageBox.style.color = '#155724';
            } else {
                messageBox.style.backgroundColor = '#cfe2ff';
                messageBox.style.borderColor = '#b6d4fe';
                messageBox.style.color = '#052c65';
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000);
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        console.log("User authenticated:", currentUserId);
                        setupRealtimeListener();
                    } else {
                        try {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        } catch (error) {
                            console.error("Error during anonymous sign-in:", error);
                            showMessage("Authentication failed. Please ensure Anonymous Authentication is enabled in your Firebase project.", 'error');
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage("Failed to initialize the application. Check console for details. Ensure your firebaseConfig is correct.", 'error');
            }
        }

        function setupRealtimeListener() {
            if (!db || !currentUserId) {
                console.warn("Firestore or User ID not ready for listener setup.");
                return;
            }

            const salesCollectionRef = collection(db, `expenses`);
            const q = query(salesCollectionRef);

            onSnapshot(q, (snapshot) => {
                allSalesData = [];
                snapshot.forEach(doc => {
                    allSalesData.push({ id: doc.id, ...doc.data() });
                });
                console.log("Real-time data update (all data):", allSalesData);
                filterExpenses();
            }, (error) => {
                console.error("Error fetching real-time sales data:", error);
                showMessage("Error loading sales data. Please refresh.", 'error');
            });
        }

        window.filterExpenses = function() {
            const selectedFilter = document.querySelector('input[name="dateFilter"]:checked').value;
            let filteredData = [...allSalesData];

            if (selectedFilter !== 'all') {
                const days = parseInt(selectedFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                cutoffDate.setHours(0, 0, 0, 0);

                filteredData = filteredData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= cutoffDate;
                });
            }
            populateTable(filteredData);
        }

        function populateTable(data) {
            salesTableBody.innerHTML = '';
            let totalExpenses = 0;
            let expensesPerPerson = { "Ram Bachan": 0, "Bikash": 0, "Ramesh": 0, "Rajkishor": 0, "Raju": 0 };

            if (data.length === 0) {
                salesTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No expenses found for this period.</td></tr>';
            } else {
                data.sort((a, b) => new Date(b.date) - new Date(a.date));

                data.forEach(sale => {
                    const row = document.createElement('tr');
                    const itemTotalPrice = sale.quantity * sale.price;
                    totalExpenses += itemTotalPrice;

                    if (expensesPerPerson.hasOwnProperty(sale.name)) {
                        expensesPerPerson[sale.name] += itemTotalPrice;
                    }

                    let actionButtons = '';
                    if (sale.createdBy === currentUserId && !sale.edited) {
                        actionButtons = `
                            <button onclick="showEditModal('${sale.id}')" class="action-btn btn-edit mr-2">Edit</button>
                            <button onclick="deleteExpense('${sale.id}')" class="action-btn btn-delete">Delete</button>
                        `;
                    } else if (sale.createdBy === currentUserId && sale.edited) {
                        actionButtons = `<span class="text-xs font-semibold text-gray-500">Locked</span>`;
                    }


                    row.innerHTML = `
                        <td class="py-2 px-4">${sale.name}</td>
                        <td class="py-2 px-4">${sale.item}</td>
                        <td class="py-2 px-4">${sale.quantity}</td>
                        <td class="py-2 px-4">${sale.price.toFixed(2)}</td>
                        <td class="py-2 px-4">${sale.date}</td>
                        <td class="py-2 px-4 font-semibold">${itemTotalPrice.toFixed(2)}</td>
                        <td class="py-2 px-4">
                            ${actionButtons}
                        </td>
                    `;
                    salesTableBody.appendChild(row);
                });
            }

            grandTotalElement.textContent = totalExpenses.toFixed(2);
            totalExpensesSummaryElement.textContent = totalExpenses.toFixed(2);
            const amountPerPerson = totalExpenses / numberOfPeople;
            amountPerPersonElement.textContent = amountPerPerson.toFixed(2);

            ramExpensesElement.textContent = expensesPerPerson["Ram Bachan"].toFixed(2);
            shyamExpensesElement.textContent = expensesPerPerson["Bikash"].toFixed(2);
            rahulExpensesElement.textContent = expensesPerPerson["Ramesh"].toFixed(2);
            sitaExpensesElement.textContent = expensesPerPerson["Rajkishor"].toFixed(2);
            rajuExpensesElement.textContent = expensesPerPerson["Raju"].toFixed(2);

            calculateSettlement(expensesPerPerson, amountPerPerson);
        }

        function calculateSettlement(expensesPerPerson, amountPerPerson) {
            settlementDetailsElement.innerHTML = '';

            if (amountPerPerson === 0) {
                settlementDetailsElement.innerHTML = '<p class="text-gray-600">No expenses to settle yet.</p>';
                return;
            }

            fixedNames.forEach(name => {
                const balance = expensesPerPerson[name] - amountPerPerson;
                const settlementItem = document.createElement('div');
                settlementItem.classList.add('settlement-item', 'flex', 'justify-between', 'py-2');

                if (balance < 0) {
                    settlementItem.innerHTML = `
                        <span>${name} needs to pay:</span>
                        <span class="amount negative font-semibold">â‚¹ ${Math.abs(balance).toFixed(2)}</span>
                    `;
                } else if (balance > 0) {
                    settlementItem.innerHTML = `
                        <span>${name} is owed:</span>
                        <span class="amount positive font-semibold">â‚¹ ${balance.toFixed(2)}</span>
                    `;
                } else {
                    settlementItem.innerHTML = `
                        <span>${name}:</span>
                        <span class="amount font-semibold">â‚¹ 0.00 (Balanced)</span>
                    `;
                }
                settlementDetailsElement.appendChild(settlementItem);
            });
        }

        async function addExpense(event) {
            event.preventDefault();

            const name = nameInput.value;
            const item = itemInput.value.trim();
            const quantity = parseFloat(quantityInput.value);
            const price = parseFloat(priceInput.value);
            const date = dateInput.value;

            if (!name || !item || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0 || !date) {
                showMessage("Please fill in all fields correctly, ensuring quantity and price are valid numbers greater than zero.", 'error');
                return;
            }

            if (!db || !currentUserId) {
                showMessage("Database not initialized or user not authenticated. Please wait or refresh.", 'error');
                return;
            }

            const newExpense = {
                name: name,
                item: item,
                quantity: quantity,
                price: price,
                date: date,
                timestamp: new Date().toISOString(),
                createdBy: currentUserId,
                edited: false 
            };

            try {
                const docRef = await addDoc(collection(db, `expenses`), newExpense);
                console.log("Document written with ID: ", docRef.id);
                showMessage("Expense added successfully!", 'success');
                expenseForm.reset();
                dateInput.value = new Date().toISOString().slice(0, 10);
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error adding expense. Please try again. Check your Firestore security rules for write access.", 'error');
            }
        }

        window.deleteExpense = async function(expenseId) {
            const expense = allSalesData.find(sale => sale.id === expenseId);
            if (!expense || expense.createdBy !== currentUserId) {
                showMessage("You are not authorized to delete this expense.", 'error');
                return;
            }
            if (expense.edited) {
                showMessage("This expense has been edited and cannot be deleted.", 'error');
                return;
            }

            const confirmed = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto text-center">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
                        <p class="text-gray-600 mb-6">Are you sure you want to delete this expense? This action cannot be undone.</p>
                        <div class="flex justify-center space-x-4">
                            <button class="cancel-btn px-6 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Cancel</button>
                            <button class="confirm-btn px-6 py-2 rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('.cancel-btn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
                modal.querySelector('.confirm-btn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
            });

            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "expenses", expenseId));
                    showMessage("Expense deleted successfully!", 'success');
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showMessage("Error deleting expense. Please try again.", 'error');
                }
            }
        }

        window.showEditModal = function(expenseId) {
            const expense = allSalesData.find(sale => sale.id === expenseId);
            if (!expense) {
                showMessage("Could not find the expense to edit.", 'error');
                return;
            }
             if (expense.createdBy !== currentUserId) {
                showMessage("You are not authorized to edit this expense.", 'error');
                return;
            }
            if (expense.edited) {
                showMessage("This expense has already been edited and is now locked.", 'error');
                return;
            }

            document.getElementById('editExpenseId').value = expense.id;
            document.getElementById('editName').value = expense.name;
            document.getElementById('editItem').value = expense.item;
            document.getElementById('editQuantity').value = expense.quantity;
            document.getElementById('editPrice').value = expense.price;
            document.getElementById('editDate').value = expense.date;

            document.getElementById('editModal').classList.remove('hidden');
        }

        async function updateExpense(event) {
            event.preventDefault();

            const expenseId = document.getElementById('editExpenseId').value;
             const expense = allSalesData.find(sale => sale.id === expenseId);
            if (!expense || expense.createdBy !== currentUserId) {
                showMessage("You are not authorized to update this expense.", 'error');
                document.getElementById('editModal').classList.add('hidden');
                return;
            }
            if (expense.edited) {
                showMessage("This expense has already been edited and cannot be updated.", 'error');
                document.getElementById('editModal').classList.add('hidden');
                return;
            }

            const updatedData = {
                name: document.getElementById('editName').value,
                item: document.getElementById('editItem').value.trim(),
                quantity: parseFloat(document.getElementById('editQuantity').value),
                price: parseFloat(document.getElementById('editPrice').value),
                date: document.getElementById('editDate').value,
                edited: true
            };

            if (!updatedData.name || !updatedData.item || isNaN(updatedData.quantity) || updatedData.quantity <= 0 || isNaN(updatedData.price) || updatedData.price <= 0 || !updatedData.date) {
                showMessage("Please fill in all fields correctly in the edit form.", 'error');
                return;
            }

            try {
                const expenseRef = doc(db, "expenses", expenseId);
                await updateDoc(expenseRef, updatedData);
                showMessage("Expense updated successfully and is now locked!", 'success');
                document.getElementById('editModal').classList.add('hidden');
            } catch (error) {
                console.error("Error updating document: ", error);
                showMessage("Error updating expense. Please try again.", 'error');
            }
        }
        
        /**
         * Handles the logic for the Quick Calculator.
         * Calculates the third field when two fields are filled.
         */
        function handleCalculation() {
            const qty = parseFloat(calcQuantityInput.value);
            const total = parseFloat(calcTotalPriceInput.value);
            const unitPrice = parseFloat(calcPricePerUnitInput.value);

            // Determine which input was just changed to avoid overwriting it
            const activeElementId = document.activeElement.id;

            // Case 1: Calculate Price/Unit
            if (qty > 0 && total > 0 && activeElementId !== 'calcPricePerUnit') {
                calcPricePerUnitInput.value = (total / qty).toFixed(2);
            } 
            // Case 2: Calculate Total Price
            else if (qty > 0 && unitPrice > 0 && activeElementId !== 'calcTotalPrice') {
                calcTotalPriceInput.value = (qty * unitPrice).toFixed(2);
            } 
            // Case 3: Calculate Quantity
            else if (total > 0 && unitPrice > 0 && activeElementId !== 'calcQuantity') {
                calcQuantityInput.value = (total / unitPrice).toFixed(2);
            }
        }

        async function clearAllData() {
            if (!db) {
                showMessage("Database not initialized. Please wait or refresh.", 'error');
                return;
            }

            const passwordEntered = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto text-center">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
                        <p class="text-gray-600 mb-4">Enter password to delete ALL expense data:</p>
                        <input type="password" id="adminPasswordInput" class="w-full p-2 border border-gray-300 rounded-md mb-4 text-gray-800" placeholder="Password"/>
                        <p id="passwordError" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p>
                        <div class="flex justify-center space-x-4">
                            <button id="cancelClearBtn" class="px-6 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">Cancel</button>
                            <button id="confirmClearBtn" class="px-6 py-2 rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete All</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                const passwordInput = document.getElementById('adminPasswordInput');
                const passwordError = document.getElementById('passwordError');

                document.getElementById('cancelClearBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(null);
                };
                document.getElementById('confirmClearBtn').onclick = () => {
                    if (passwordInput.value === ADMIN_PASSWORD) {
                        document.body.removeChild(modal);
                        resolve(passwordInput.value);
                    } else {
                        passwordError.classList.remove('hidden');
                        passwordInput.value = '';
                    }
                };
                passwordInput.focus();
            });


            if (passwordEntered === ADMIN_PASSWORD) {
                try {
                    const q = query(collection(db, `expenses`));
                    const querySnapshot = await getDocs(q);
                    const deletePromises = [];

                    querySnapshot.forEach((docToDelete) => {
                        deletePromises.push(deleteDoc(doc(db, `expenses`, docToDelete.id)));
                    });

                    await Promise.all(deletePromises);
                    showMessage("All expenses cleared successfully!", 'success');
                } catch (e) {
                    console.error("Error clearing documents: ", e);
                    showMessage("Error clearing expenses. Please try again. Check your Firestore security rules for delete access.", 'error');
                }
            } else if (passwordEntered !== null) {
                showMessage("Incorrect password. Data not cleared.", 'error');
            }
        }

        // Set today's date as default for the date input
        dateInput.value = new Date().toISOString().slice(0, 10);

        // Event listeners
        expenseForm.addEventListener('submit', addExpense);
        clearAllDataBtn.addEventListener('click', clearAllData);
        document.getElementById('editExpenseForm').addEventListener('submit', updateExpense);
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('editModal').classList.add('hidden');
        });

        // Quick Calculator Event Listeners
        [calcQuantityInput, calcTotalPriceInput, calcPricePerUnitInput].forEach(input => {
            // Make all calculator inputs editable
            if(input.id !== 'calcPricePerUnit') {
                 input.addEventListener('input', handleCalculation);
            } else {
                // Price per unit is calculated, but let's allow editing it too
                input.readOnly = false;
                input.classList.remove('bg-gray-200');
                input.addEventListener('input', handleCalculation);
            }
        });

        clearCalcBtn.addEventListener('click', () => {
            calcQuantityInput.value = '';
            calcTotalPriceInput.value = '';
            calcPricePerUnitInput.value = '';
        });

        useCalcValuesBtn.addEventListener('click', () => {
            const qty = calcQuantityInput.value;
            const price = calcPricePerUnitInput.value;
            if (qty > 0 && price > 0) {
                quantityInput.value = qty;
                priceInput.value = price;
                showMessage('Values copied to the expense form!', 'success');
            } else {
                showMessage('Please calculate valid quantity and price first.', 'warning');
            }
        });


        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
